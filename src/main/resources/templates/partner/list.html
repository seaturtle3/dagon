<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>파트너 신청 목록</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        .pagination { margin-top: 15px; text-align: center; }
        .pagination button { margin: 0 3px; cursor: pointer; padding: 5px 10px; }
        .pagination button.active { background-color: #4CAF50; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .search-container { margin: 20px 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px; }
        #searchKeyword { padding: 5px; width: 200px; }
        select { padding: 5px; }
        button { padding: 5px 10px; cursor: pointer; }
        h1 { color: #333; }
    </style>
</head>
<body>
<h1>파트너 신청 목록</h1>

<div class="search-container">
    <label>검색 기준:</label>
    <select id="searchType">
        <option value="pname">상호명</option>
        <option value="uname">신청자 이름</option>
    </select>

    <input type="text" id="searchKeyword" placeholder="검색어 입력">

    <label>상태:</label>
    <select id="statusFilter">
        <option value="">전체</option>
        <option value="심사중">심사중</option>
        <option value="반려">반려</option>
        <option value="승인됨">승인됨</option>
    </select>

    <button onclick="loadData(0)">검색</button>
</div>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>상호명</th>
        <th>신청자</th>
        <th>상태</th>
    </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<div id="pagination" class="pagination"></div>

<script>
    const size = 10;
    let currentPage = 0;

    function loadData(page) {
        currentPage = page;
        const keyword = $('#searchKeyword').val();
        const type = $('#searchType').val();
        const status = $('#statusFilter').val();
        const token = localStorage.getItem('accessToken');
        console.log("토큰:", token); // null 또는 undefined라면 문제!

        console.log(`Loading data with page=${page}, size=${size}, keyword=${keyword}, type=${type}, status=${status}`);

        $.ajax({
            url: `/api/partners`,
            type: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            data: {
                page: page,
                size: size,
                keyword: keyword,
                type: type,
                status: status
            },
            success: function(data) {
                console.log('Data fetched successfully:', data);
                renderTable(data);
                renderPagination(data);
            },
            error: function(xhr) {
                console.error('Error fetching data', xhr.responseText);
                alert('데이터를 불러오는 중 오류가 발생했습니다.');
            }
        });
    }

    function renderTable(data) {
        const body = $('#tableBody');
        body.empty();

        if (data.content.length === 0) {
            body.append(`
                <tr>
                    <td colspan="4">검색 결과가 없습니다.</td>
                </tr>
            `);
            return;
        }

        data.content.forEach(item => {
            body.append(`
                <tr onclick="goToDetail(${item.pid})" style="cursor:pointer;">
                    <td>${item.pid}</td>
                    <td>${item.pname}</td>
                    <td>${item.displayName}</td>
                    <td>${item.pstatus}</td>
                </tr>
            `);
        });
    }

    function renderPagination(data) {
        const pagination = $('#pagination');
        pagination.empty();

        // 처음 페이지로 이동 버튼
        if (data.totalPages > 1) {
            pagination.append(`<button onclick="loadData(0)">&laquo;</button>`);
        }

        // 페이지 버튼 생성
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(data.totalPages - 1, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            pagination.append(`<button class="${activeClass}" onclick="loadData(${i})">${i + 1}</button>`);
        }

        // 마지막 페이지로 이동 버튼
        if (data.totalPages > 1) {
            pagination.append(`<button onclick="loadData(${data.totalPages - 1})">&raquo;</button>`);
        }
    }

    function goToDetail(id) {
        window.location.href = `/partner/detail/${id}`;
    }

    $(document).ready(function () {
        loadData(0);
    });
</script>
</body>
</html>